"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
class AssetRelocatorPatch {
    constructor(isProd, nodeIntegration) {
        this.isProd = isProd;
        this.nodeIntegration = nodeIntegration;
    }
    injectedProductionDirnameCode() {
        if (this.nodeIntegration) {
            // In production the assets are found one directory up from
            // __dirname
            return 'require("path").resolve(__dirname, "..")';
        }
        // If nodeIntegration is disabled, we replace __dirname
        // with an empty string so no error is thrown at runtime
        return '""';
    }
    apply(compiler) {
        compiler.hooks.compilation.tap('asset-relocator-forge-patch', (compilation) => {
            // We intercept the Vercel loader code injection and replace __dirname with
            // code that works with Electron Forge
            //
            // Here is where the injection occurs:
            // https://github.com/vercel/webpack-asset-relocator-loader/blob/4710a018fc8fb64ad51efb368759616fb273618f/src/asset-relocator.js#L331-L339
            compilation.mainTemplate.hooks.requireExtensions.intercept({
                register: (tapInfo) => {
                    if (tapInfo.name === 'asset-relocator-loader') {
                        const originalFn = tapInfo.fn;
                        tapInfo.fn = (source, chunk) => {
                            const originalInjectCode = originalFn(source, chunk);
                            // Since this is not a public API of the Vercel loader, it could
                            // change on patch versions and break things.
                            //
                            // If the injected code changes substantially, we throw an error
                            if (!originalInjectCode.includes('__webpack_require__.ab = __dirname + ')) {
                                throw new Error('The installed version of @vercel/webpack-asset-relocator-loader does not appear to be compatible with Forge');
                            }
                            if (this.isProd) {
                                return originalInjectCode.replace('__dirname', this.injectedProductionDirnameCode());
                            }
                            return originalInjectCode.replace('__dirname', 
                            // In development, the app is loaded via webpack-dev-server
                            // so __dirname is useless because it points to Electron
                            // internal code. Instead we hard-code the absolute path to
                            // the webpack output.
                            JSON.stringify(compiler.options.output.path));
                        };
                    }
                    return tapInfo;
                },
            });
        });
    }
}
exports.default = AssetRelocatorPatch;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXNzZXRSZWxvY2F0b3JQYXRjaC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL0Fzc2V0UmVsb2NhdG9yUGF0Y2gudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFFQSxNQUFxQixtQkFBbUI7SUFLdEMsWUFBWSxNQUFlLEVBQUUsZUFBd0I7UUFDbkQsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLGVBQWUsR0FBRyxlQUFlLENBQUM7SUFDekMsQ0FBQztJQUVPLDZCQUE2QjtRQUNuQyxJQUFJLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUN6QiwyREFBMkQ7WUFDM0QsWUFBWTtZQUNaLE9BQU8sMENBQTBDLENBQUM7UUFDcEQsQ0FBQztRQUVELHVEQUF1RDtRQUN2RCx3REFBd0Q7UUFDeEQsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRU0sS0FBSyxDQUFDLFFBQWtCO1FBQzdCLFFBQVEsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyw2QkFBNkIsRUFBRSxDQUFDLFdBQVcsRUFBRSxFQUFFO1lBQzVFLDJFQUEyRTtZQUMzRSxzQ0FBc0M7WUFDdEMsRUFBRTtZQUNGLHNDQUFzQztZQUN0QywwSUFBMEk7WUFDMUksV0FBVyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDO2dCQUN6RCxRQUFRLEVBQUUsQ0FBQyxPQUFPLEVBQUUsRUFBRTtvQkFDcEIsSUFBSSxPQUFPLENBQUMsSUFBSSxLQUFLLHdCQUF3QixFQUFFLENBQUM7d0JBQzlDLE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxFQUE4QyxDQUFDO3dCQUUxRSxPQUFPLENBQUMsRUFBRSxHQUFHLENBQUMsTUFBYyxFQUFFLEtBQVksRUFBRSxFQUFFOzRCQUM1QyxNQUFNLGtCQUFrQixHQUFHLFVBQVUsQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLENBQUM7NEJBRXJELGdFQUFnRTs0QkFDaEUsNkNBQTZDOzRCQUM3QyxFQUFFOzRCQUNGLGdFQUFnRTs0QkFDaEUsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyx1Q0FBdUMsQ0FBQyxFQUFFLENBQUM7Z0NBQzFFLE1BQU0sSUFBSSxLQUFLLENBQUMsNkdBQTZHLENBQUMsQ0FBQzs0QkFDakksQ0FBQzs0QkFFRCxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztnQ0FDaEIsT0FBTyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyw2QkFBNkIsRUFBRSxDQUFDLENBQUM7NEJBQ3ZGLENBQUM7NEJBRUQsT0FBTyxrQkFBa0IsQ0FBQyxPQUFPLENBQy9CLFdBQVc7NEJBQ1gsMkRBQTJEOzRCQUMzRCx3REFBd0Q7NEJBQ3hELDJEQUEyRDs0QkFDM0Qsc0JBQXNCOzRCQUN0QixJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUM3QyxDQUFDO3dCQUNKLENBQUMsQ0FBQztvQkFDSixDQUFDO29CQUVELE9BQU8sT0FBTyxDQUFDO2dCQUNqQixDQUFDO2FBQ0YsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0Y7QUFqRUQsc0NBaUVDIn0=